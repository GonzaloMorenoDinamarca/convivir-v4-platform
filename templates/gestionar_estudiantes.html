<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Estudiantes - CONVIVIR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .filter-group input {
            flex: 1;
        }
        
        .filter-group select {
            min-width: 150px;
        }
        
        .students-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .students-table th,
        .students-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .students-table th {
            background: #f8f9fa;
            color: #667eea;
            font-weight: 600;
        }
        
        .students-table tr:hover {
            background: #f8f9fa;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            margin-right: 5px;
        }
        
        .btn-edit {
            background: #4299e1;
            color: white;
        }
        
        .btn-edit:hover {
            background: #3182ce;
        }
        
        .btn-delete {
            background: #f56565;
            color: white;
        }
        
        .btn-delete:hover {
            background: #e53e3e;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
            padding: 12px 24px;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .btn-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë• Gestionar Estudiantes</h1>
            <p>Administra la informaci√≥n de los estudiantes del establecimiento</p>
        </div>
        
        <div class="content">
            <!-- Estad√≠sticas -->
            <div class="stats">
                <div class="stat-card">
                    <h3 id="total-estudiantes">0</h3>
                    <p>Total Estudiantes</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-cursos">0</h3>
                    <p>Cursos</p>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="section">
                <h2>üîç Buscar Estudiantes</h2>
                <div class="filter-group">
                    <input type="text" id="buscar" placeholder="Buscar por nombre o ID...">
                    <select id="filtro-curso">
                        <option value="">Todos los cursos</option>
                    </select>

                </div>
            </div>
            
            <!-- Tabla de estudiantes -->
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìã Lista de Estudiantes</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="mostrarModalAgregar()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>‚ûï</span> Agregar Estudiante
                        </button>
                        <button onclick="eliminarTodosLosEstudiantes()" class="btn-delete-all" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>üóëÔ∏è</span> Eliminar Todos los Estudiantes
                        </button>
                    </div>
                </div>
                <div id="tabla-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>Cargando estudiantes...</p>
                    </div>
                </div>
            </div>
            
            <!-- Botones de navegaci√≥n -->
            <div class="btn-container">
                <button class="btn btn-secondary" onclick="window.location.href='/'">Volver al Dashboard</button>
                <button class="btn btn-primary" onclick="window.location.href='/configurar_cursos'">Configurar Cursos</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para agregar estudiante -->
    <div id="modal-agregar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Agregar Estudiante</h2>
            </div>
            <form id="form-agregar">
                <div class="form-group">
                    <label>Nombre del Estudiante: *</label>
                    <input type="text" id="add-nombre" placeholder="Ej: GONZ√ÅLEZ P√âREZ JUAN PABLO" required>
                </div>
                <div class="form-group">
                    <label>Curso: *</label>
                    <select id="add-curso" required>
                        <option value="">Seleccione un curso</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalAgregar()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Estudiante</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para editar estudiante -->
    <div id="modal-editar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Estudiante</h2>
            </div>
            <form id="form-editar">
                <div class="form-group">
                    <label>ID Actual:</label>
                    <input type="text" id="edit-id-actual" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label>Nuevo Nombre/ID: *</label>
                    <input type="text" id="edit-nuevo-nombre" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let estudiantesData = [];
        
        // Cargar estudiantes al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            cargarEstudiantes();
            cargarCursos();
        });
        
        // Event listeners para filtros
        document.getElementById('buscar').addEventListener('input', filtrarEstudiantes);
        document.getElementById('filtro-curso').addEventListener('change', filtrarEstudiantes);
        
        // Form submit para agregar estudiante
        document.getElementById('form-agregar').addEventListener('submit', async (e) => {
            e.preventDefault();
            await agregarEstudiante();
        });
        
        // Form submit para editar
        document.getElementById('form-editar').addEventListener('submit', async (e) => {
            e.preventDefault();
            await guardarEdicion();
        });
        
        async function cargarEstudiantes() {
            try {
                const response = await fetch('/api/listar_estudiantes');
                const data = await response.json();
                
                if (data.exito) {
                    estudiantesData = data.estudiantes;
                    document.getElementById('total-estudiantes').textContent = data.total;
                    mostrarEstudiantes(estudiantesData);
                } else {
                    mostrarError('No se pudieron cargar los estudiantes');
                }
            } catch (error) {
                mostrarError('Error al cargar estudiantes: ' + error.message);
            }
        }
        
        async function cargarCursos() {
            try {
                const response = await fetch('/api/cursos_disponibles');
                const data = await response.json();
                
                if (data.exito) {
                    const selectFiltro = document.getElementById('filtro-curso');
                    const selectAgregar = document.getElementById('add-curso');
                    
                    data.cursos.forEach(curso => {
                        // Para el filtro
                        const optionFiltro = document.createElement('option');
                        optionFiltro.value = curso;
                        optionFiltro.textContent = curso;
                        selectFiltro.appendChild(optionFiltro);
                        
                        // Para el modal de agregar
                        const optionAgregar = document.createElement('option');
                        optionAgregar.value = curso;
                        optionAgregar.textContent = curso;
                        selectAgregar.appendChild(optionAgregar);
                    });
                    
                    // Contar cursos √∫nicos
                    const cursosUnicos = new Set(estudiantesData.map(e => e.curso_id));
                    document.getElementById('total-cursos').textContent = cursosUnicos.size;
                }
            } catch (error) {
                console.error('Error al cargar cursos:', error);
            }
        }
        
        function mostrarEstudiantes(estudiantes) {
            const container = document.getElementById('tabla-container');
            
            if (estudiantes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>No se encontraron estudiantes</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>ID / Nombre</th>
                            <th>Curso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            estudiantes.forEach(est => {
                html += `
                    <tr>
                        <td><strong>${est.estudiante_id}</strong></td>
                        <td>${est.curso_id}</td>
                        <td>
                            <button class="btn btn-edit" onclick="editarEstudiante('${est.estudiante_id}')">‚úèÔ∏è Editar</button>
                            <button class="btn btn-delete" onclick="eliminarEstudiante('${est.estudiante_id}')">üóëÔ∏è Eliminar</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function filtrarEstudiantes() {
            const busqueda = document.getElementById('buscar').value.toLowerCase();
            const curso = document.getElementById('filtro-curso').value;
            
            let filtrados = estudiantesData.filter(est => {
                const matchBusqueda = est.estudiante_id.toLowerCase().includes(busqueda);
                const matchCurso = !curso || est.curso_id === curso;
                
                return matchBusqueda && matchCurso;
            });
            
            mostrarEstudiantes(filtrados);
        }
        
        function editarEstudiante(estudianteId) {
            document.getElementById('edit-id-actual').value = estudianteId;
            document.getElementById('edit-nuevo-nombre').value = estudianteId;
            document.getElementById('modal-editar').style.display = 'block';
        }
        
        async function guardarEdicion() {
            const idActual = document.getElementById('edit-id-actual').value;
            const nuevoNombre = document.getElementById('edit-nuevo-nombre').value;
            
            if (!nuevoNombre.trim()) {
                alert('El nuevo nombre no puede estar vac√≠o');
                return;
            }
            
            try {
                const response = await fetch('/api/editar_estudiante', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        estudiante_id: idActual,
                        nuevo_nombre: nuevoNombre
                    })
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    alert(data.mensaje);
                    cerrarModal();
                    await cargarEstudiantes();
                } else {
                    alert('Error: ' + data.mensaje);
                }
            } catch (error) {
                alert('Error al editar estudiante: ' + error.message);
            }
        }
        
        async function eliminarEstudiante(estudianteId) {
            if (!confirm(`¬øEst√°s seguro de eliminar al estudiante "${estudianteId}"?\n\nEsta acci√≥n eliminar√° todos sus datos relacionados (interacciones, alertas, comentarios).`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/eliminar_estudiante', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estudiante_id: estudianteId })
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    alert(data.mensaje);
                    await cargarEstudiantes();
                } else {
                    alert('Error: ' + data.mensaje);
                }
            } catch (error) {
                alert('Error al eliminar estudiante: ' + error.message);
            }
        }
        
        async function agregarEstudiante() {
            const nombre = document.getElementById('add-nombre').value.trim();
            const curso = document.getElementById('add-curso').value;
            
            if (!nombre || !curso) {
                alert('‚ö†Ô∏è Por favor, completa todos los campos');
                return;
            }
            
            try {
                // Generar un RUN √∫nico basado en timestamp
                const timestamp = Date.now();
                const run = `99.${String(timestamp).slice(-6, -3)}.${String(timestamp).slice(-3)}-${timestamp % 10}`;
                
                const response = await fetch('/api/guardar_estudiantes_curso', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        curso_id: curso,
                        estudiantes: [{
                            run: run,
                            nombre_completo: nombre,
                            edad: 14,
                            genero: 'M'
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    alert('‚úÖ Estudiante agregado exitosamente');
                    cerrarModalAgregar();
                    await cargarEstudiantes();
                } else {
                    alert('‚ùå Error: ' + data.mensaje);
                }
            } catch (error) {
                alert('‚ùå Error al agregar estudiante: ' + error.message);
            }
        }
        
        function cerrarModal() {
            document.getElementById('modal-editar').style.display = 'none';
        }
        
        function mostrarModalAgregar() {
            document.getElementById('modal-agregar').style.display = 'block';
        }
        
        function cerrarModalAgregar() {
            document.getElementById('modal-agregar').style.display = 'none';
            document.getElementById('form-agregar').reset();
        }
        
        function mostrarError(mensaje) {
            const container = document.getElementById('tabla-container');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <p>${mensaje}</p>
                </div>
            `;
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modalEditar = document.getElementById('modal-editar');
            const modalAgregar = document.getElementById('modal-agregar');
            if (event.target === modalEditar) {
                cerrarModal();
            }
            if (event.target === modalAgregar) {
                cerrarModalAgregar();
            }
        }
        
        async function eliminarTodosLosEstudiantes() {
            const confirmacion = confirm('‚ö†Ô∏è ¬øEst√°s ABSOLUTAMENTE SEGURO de eliminar TODOS los estudiantes?\n\nEsta acci√≥n:\n- Eliminar√° TODOS los estudiantes\n- Eliminar√° TODOS los datos relacionados (comentarios, interacciones, alertas)\n- NO se puede deshacer\n\nEscribe "ELIMINAR TODO" para confirmar.');
            
            if (!confirmacion) {
                return;
            }
            
            const confirmacionFinal = prompt('Por favor, escribe "ELIMINAR TODO" para confirmar (en may√∫sculas):');
            
            if (confirmacionFinal !== 'ELIMINAR TODO') {
                alert('‚ùå Operaci√≥n cancelada. No se escribi√≥ la confirmaci√≥n correcta.');
                return;
            }
            
            try {
                const response = await fetch('/api/eliminar_todos_estudiantes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    alert(`‚úÖ ${data.mensaje}\n\nEstudiantes eliminados: ${data.estudiantes_eliminados}`);
                    cargarEstudiantes(); // Recargar la tabla
                } else {
                    alert('‚ùå Error: ' + data.mensaje);
                }
            } catch (error) {
                alert('‚ùå Error al eliminar estudiantes: ' + error.message);
            }
        }
    </script>
</body>
</html>

